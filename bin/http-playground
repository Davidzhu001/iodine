#!/usr/bin/env ruby

Dir.chdir(File.expand_path(File.join('..', '..'), __FILE__))
puts `rake clean`
puts `rake compile`

require 'benchmark'
$LOAD_PATH.unshift File.expand_path(File.join('..', '..', 'lib'), __FILE__ )
require "bundler/setup"
require "iodine"
require 'rack'


class WSEcho
  def initialize srv
    @srv = srv
  end
  def on_open
    puts "We have a websocket connection"
  end
  def on_close
    puts "Bye Bye... only #{ws_count} left..."
  end
  def on_shutdown
    puts "I'm shutting down #{self}"
  end
  def on_message data
    puts data
    data = data.dup
    each {|h| h.echo data }
  end
  def echo data
    write "echo: #{data}"
  end
end

# create the server object and setup any settings we might need.
server = Iodine::Http.new
server.threads ||= 1
server.processes ||= 1
server.timeout ||= 1
server.public_folder = '/Users/2Be/Documents/Scratch'
count = 2
server.on_http= Proc.new do |env|
  # out = env["rack.hijack"].call Proc.new {
  #   env["rack.hijack_io"].write "Partial Hijack!\n"
  #   env["rack.hijack_io"].close
  # }
  # [200,{"Content-Length" => "8", "Connection" => "close"}, []]
  # count += 1
  # raise "you're odd!" if(count.odd?)
  out = "ENV:\r\n#{env.to_a.map {|h| "#{h[0]}: #{h[1]}"} .join "\n"}"
  request = Rack::Request.new(env)
  out += "\nRequest Path: #{request.path_info}\nParams:\r\n#{request.params.to_a.map {|h| "#{h[0]}: #{h[1]}"} .join "\n"}" unless(request.params.empty?)
  [200, {"Content-Length" => out.length}, [out]];
end

server.on_http= Proc.new do |env|
  # [200, {"Content-Length".freeze => "12".freeze}, ["Hello World!".freeze]];
  req = Rack::Request.new env
  res = Rack::Response.new
  res.write "Hello World!".freeze
  res.to_a
end

server.on_websocket= Proc.new do |env|
  [0,{}, [], WSEcho.new(server)];
end

server.on_start do
  # server.run {puts "I'm running!"}
  # server.run_after(5000) {puts "5 seconds have passed."}
  server.run_every(1000) {puts "#{server.count} clients connected."}
  # server.run_every(10000) do
  #   begin
  #     puts "making a system call"
  #     puts `ab -n 100000 -c 200 -k http://127.0.0.1:3000/`
  #   rescue => e
  #     l = Logger.new STDOUT
  #     l.error e
  #   end
  # end
end


# server.on_start do
#   server.run_every(1000) {puts "#{server.connection_count} clients connected."}
# end

# puts "Press enter to start"
# gets

server.start

# def nag
#   puts `ab -n 200000 -c 2000 -k http://127.0.0.1:3000/`
#   sleep 2
# end
#
# nag while true
#
# def nag
#   puts `wrk -c2000 -d10 -t4 http://localhost:3000/`
#   sleep 3
# end
#
# nag while true

# ab -n 100000 -c 200 -k http://127.0.0.1:3000/
# ab -n 100000 -c 4000 -k http://127.0.0.1:3000/
# ab -n 1000000 -c 20000 -k http://127.0.0.1:3000/
# ~/ruby/wrk/wrk -c400 -d10 -t12 http://localhost:3000/
# wrk -c200 -d4 -t12 http://localhost:3000/
# RACK_ENV="production" rackup -p 3000 -s iodine

# ws = new WebSocket("ws://localhost:3000"); ws.onmessage = function(e) {console.log("Got message!"); console.log(e.data);}; ws.onclose = function(e) {console.log("closed")}; ws.onopen = function(e) {ws.send("hi");};
